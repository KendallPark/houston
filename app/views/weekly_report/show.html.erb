<div class="weekly-report">
  <h1 class="weekly-report-heading">
    Weekly Report
    <span class="subtitle">
      <%= link_to "Prev", weekly_report_path(1.week.until(@date_range.begin)) unless for_email? %>
      Week of <b><%= @date_range.begin.strftime("%B %e") %></b><% if @date_range.begin.year != Date.today.year %>, <%= @date_range.begin.year %><% end %>
      <% next_date = 1.week.since(@date_range.begin) %>
      <% unless for_email? %>
        <% if next_date <= Date.today %>
          <%= link_to "Next", weekly_report_path(next_date) %>
        <% else %>
          <span class="disabled">Next</span>
        <% end %>
      <% end %>
    </span>
  </h1>



  <h3 class="heading">
    <%= image_tag image_url("heading-commits-48.png"), size: "48" %>
    Commits
  </h3>

  <%
    
    weekday_by_wday = %w{Weekend Monday Tuesday Wednesday Thursday Friday Weekend}
    weekdays = %w{Monday Tuesday Wednesday Thursday Friday Weekend}
    commits_by_weekday = Hash[weekdays.zip([[], [], [], [], [], []])]
    commits_by_project = {}
    projects_with_commits = 0
    total_commits = 0
    total_bugs = 0
    commits_by_week_by_project = Hash[@projects.zip]
    
    weeks_of_commit_history = 25
    date_range_multiweek = ((weeks_of_commit_history - 1).weeks.before(@date_range.begin))..@date_range.end
    commit_history_weeks = date_range_multiweek.step(7)
    
    weeks_of_errbit_history = 15
    date_range_multiweek2 = ((weeks_of_errbit_history - 1).weeks.before(@date_range.begin))..@date_range.end
    errbit_history_weeks = date_range_multiweek2.step(7)
    
    time_range = @date_range.begin.beginning_of_day.to_time.to_i...@date_range.end.end_of_day.to_time.to_i
    time_range_multiweek = date_range_multiweek.begin.beginning_of_day.to_time.to_i...date_range_multiweek.end.end_of_day.to_time.to_i
    
    
    
    benchmark("Preparing data for commits graphs") do
      @projects.each do |project|
        
        commits_by_week = (commits_by_week_by_project[project] ||= Hash[commit_history_weeks.zip([0]*weeks_of_commit_history)])
        commits_this_week = false
        
        
        # commits = benchmark("[#{project.slug}] read commits") {
        #   `git --git-dir=#{project.git_dir} log --all --pretty='%at'`.split(/\n/).uniq
        # }
        commits = `git --git-dir=#{project.git_dir} log --all --pretty='%at'`.split(/\n/).uniq
        
        commits.each do |commit|
          timestamp = commit.to_i
          
          if time_range_multiweek.include?(timestamp)
            time = Time.at(timestamp)
            date = time.to_date
            
            week = date.beginning_of_week
            commits_by_week[week] = commits_by_week[week] + 1
            
            if time_range.include?(timestamp)
              weekday = weekday_by_wday[date.wday]
              
              commits_by_project[project] = commits_by_project.fetch(project, 0) + 1
              commits_by_weekday[weekday].push(color: project.color, project: project.name)
              commits_this_week = true
            end
          end
        end
        
        
        
        projects_with_commits += 1 if commits_this_week
      end
      
      total_commits = commits_by_project.values.sum
    end
    
    
    
    bug_counts_by_project = {}
    bugs_by_week_by_project = Hash[@projects.zip]
    
    benchmark("Preparing data for bugs graphs") do
      
      bugs = Bug.during(date_range_multiweek2)
      
      bugs.each do |bug|
        project = @projects.detect { |project| project.errbit_app_id == bug.errbit_app_id }
        bugs_by_week = (bugs_by_week_by_project[project] ||= Hash[errbit_history_weeks.zip([0]*weeks_of_errbit_history)])
        bug_counts = (bug_counts_by_project[project] ||= {"fixed" => 0, "new" => 0, "open" => 0})
        
        errbit_history_weeks.each do |week|
          
          # open during week?
          if (bug.first_notice_at < week) && (bug.resolved_at.nil? || bug.resolved_at >= 7.days.after(week))
            bugs_by_week[week] += 1
          end
          
        end
        
        if (bug.first_notice_at < @date_range.end) && (bug.resolved_at.nil? || bug.resolved_at >= @date_range.begin)
          
          status = bug.resolved? ? "fixed" : (bug.first_notice_at >= @date_range.begin) ? "new" : "open"
          bug_counts[status] += 1
          
        end
        
      end
      
      
      total_bugs = bug_counts_by_project.values.map(&:values).flatten.sum
    end
    
    
    
    notices_by_week = Hash[errbit_history_weeks.zip([0]*weeks_of_errbit_history)]
    
    benchmark("Preparing data for notices graphs") do
      
      notices = Notice.during(date_range_multiweek2)
      
      notices.each do |notice|
        week = notice.created_at.beginning_of_week.to_date
        next unless notices_by_week.key?(week) # we're getting notices for the monday after the sunday that should end the range
        notices_by_week[week] += 1
      end
      
    end
    
    
    
    # def rgb(r,g,b); "#{r.to_s(16).rjust(2, '0')}#{g.to_s(16).rjust(2, '0')}#{b.to_s(16).rjust(2, '0')}"; end
    colors = {
      "teal" => "52b3ad",
      "sky" => "239ce7",
      "indigo" => "7d63b8",
      "thistle" => "b35ab8",
      "tomato" => "e74c23",
      "hazelnut" => "a4703d",
      "burnt_sienna" => "df8a3d",
      "orange" => "e9b84e",
      "pea" => "8dc63f",
      "spruce" => "54a043",
      "slate" => "8d918f"
    }
    
    
  %>
  
  <div class="weekly-report-body">
    
    <table class="layout">
      <tr>
        <td colspan="2">
    
          <table class="commits">
            <thead>
              <tr>
                <% weekdays.each do |weekday| %>
                  <th width="80"><%= weekday %></th>
                <% end %>
                <td></td>
              </tr>
            </thead>
            <tbody>
              <tr>
                <% weekdays.each do |weekday| %>
                  <td width="80">
                    <% commits_by_weekday[weekday].each do |commit| %><b class="commit bubble <%= commit[:color] %>" rel="tooltip" title="<%= commit[:project] %>"></b><% end %>
                  </td>
                <% end %>

                <td class="score">
                  <p class="total-commits">
                    <span class="score-count"><%= total_commits %></span>
                    <span class="score-label"><%= total_commits == 1 ? "Commit" : "Commits" %></span>
                  </p>
                  <p class="total-projects">
                    <span class="score-count"><%= projects_with_commits %></span>
                    <span class="score-label"><%= projects_with_commits == 1 ? "Project" : "Projects" %></span>
                  </p>
                </td>
              </tr>
            </tbody>
          </table>
        
        </td>
      </tr>
      
      <tr>
        <td width="40%">
          <%= image_tag Gchart.pie(
                :data => commits_by_project.values,
                :bar_colors => commits_by_project.keys.map { |project| colors[project.color] },
                :size => "320x80",
                :labels => commits_by_project.keys.map(&:name) ),
              :width => 320,
              :height => 80 %>
          <h5 style="margin-top: 0.25em; text-align: center;">Focus this week</h5>
        </td>
        
        <td width="60%">
          <% width = ((14 + 4) * weeks_of_commit_history) + 10 %>
          <%= image_tag Gchart.bar(
                :data => @projects.map { |project| commits_by_week_by_project[project].values },
                :bar_colors => @projects.map { |project| colors[project.color] },
                :bar_width_and_spacing => 14,
                :size => "#{width}x80" ) + "&chxs=0,676767,0,0,_,676767|1,676767,0,0,_,676767&chxt=x,y",
              :width => width,
              :height => 80 %>
          <h5 style="margin-top: 0.25em; text-align: center;"><%= weeks_of_commit_history %>-week commit history</h5>
        </td>
      </tr>
      
    </table>
    
  </div>



  <h3 class="heading">
    <%= image_tag image_url("heading-bugs-48.png"), size: "48" %>
    Bugs
  </h3>
  
  <div class="weekly-report-body">
    <% if total_bugs == 0 %>
    
      <h1>No bugs! You win!</h1>
    
    <% else %>
    
      <table class="layout">
        <tr>
          <td colspan="3">
            
            <table class="bugs">
              <% @projects.where("errbit_app_id IS NOT NULL").each do |project| %>
                <% bug_counts = bug_counts_by_project[project] || {} %>
                <% if bug_counts.values.sum > 0 %>
                  <tr>
                    <th><%= project.name %></th>
                    <td>
                      <% bug_counts["new"].times do %>
                        <%= image_tag(image_url("bug-new-32.png"), size: 32, :class => "bug") %>
                      <% end %>
                      <% bug_counts["open"].times do %>
                        <%= image_tag(image_url("bug-open-32.png"), size: 32, :class => "bug") %>
                      <% end %>
                      <% bug_counts["fixed"].times do %>
                        <%= image_tag(image_url("bug-fixed-32.png"), size: 32, :class => "bug") %>
                      <% end %>
                    </td>
                    <td class="score">
                      <p class="new-bugs <%= "zero" if bug_counts["new"].zero? %>">
                        <span class="score-count"><span class="sign">+</span><%= bug_counts["new"] %></span>
                        <span class="score-label">New</span>
                      </p>
                      <p class="resolved-bugs <%= "zero" if bug_counts["fixed"].zero? %>">
                        <span class="score-count"><span class="sign">&minus;</span><%= bug_counts["fixed"] %></span>
                        <span class="score-label">Fixed</span>
                      </p>
                      <p class="open-bugs">
                        <span class="score-count"><%= bug_counts["open"] + bug_counts["new"] %></span>
                        <span class="score-label">Open</span>
                      </p>
                    </td>
                  </tr>
                <% end %>
              <% end %>
            </table>
            
          </td>
        </tr>

        <tr>
          <td width="33%">
            <% width = ((14 + 4) * weeks_of_errbit_history) + 10 %>
            <%= image_tag Gchart.bar(
                  :data => notices_by_week.values,
                  :bar_colors => '888888',
                  :bar_width_and_spacing => 14,
                  :size => "#{width}x80" ) + "&chxs=0,676767,0,0,_,676767|1,676767,0,0,_,676767&chxt=x,y",
                :width => width,
                :height => 80 %>
            <h5 style="margin-top: 0.25em; text-align: center;"><%= weeks_of_errbit_history %>-week notice levels</h5>
          </td>

          <td width="33%">
          </td>

          <td width="33%">
            <% width = ((14 + 4) * weeks_of_errbit_history) + 10 %>
            <%= image_tag Gchart.bar(
                  :data => @projects.map { |project| bugs_by_week_by_project[project].try(:values) || [0]*weeks_of_errbit_history },
                  :bar_colors => @projects.map { |project| colors[project.color] },
                  :bar_width_and_spacing => 14,
                  :size => "#{width}x80" ) + "&chxs=0,676767,0,0,_,676767|1,676767,0,0,_,676767&chxt=x,y",
                :width => width,
                :height => 80 %>
            <h5 style="margin-top: 0.25em; text-align: center;"><%= weeks_of_errbit_history %>-week problem count</h5>
          </td>
        </tr>

      </table>
    
    <% end %>
  </div>
  

  <!-- <h3 class="heading">
    <b class="heading icon tickets"></b>
    Tickets
  </h3>

  <table>
  </table> -->
</div>

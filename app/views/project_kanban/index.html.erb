<a id="full_screen_link">Full Screen</a>

<%= render partial: "kanban/kanban", locals: {projects: [@project]} %>

<div id="modal" style='display:none;padding:15px;' class='modal'>
  <form action="kanban/<%= @project.slug %>/staged_for_development" method="POST">
    <label for="ticket_number"><h3>Input Unfuddle Ticket Number</h3></label>
    <input type="text" name="ticket_number" value="" id="ticket_number">
    <input type="submit" value="Fetch Ticket">
  </form>
  <div id="error"></div>
</div>

<% content_for :scripts do %>
  <script type="text/javascript">
    $(function() {
      
      window.kanban = new Kanban({
        projects: [{slug: '<%= @project.slug %>', color: '<%= @project.color %>'}],
        queues: <%= raw KanbanQueue.slugs %>
      });
      
      kanban.loadQueues();
      
      function autoUpdate() {
        kanban.el.addClass('auto-update');
        $('#auto_update').remove();
        $('#timer_wrapper').fadeIn();
        new Refresher({time: 300000, callback: kanban.loadQueues.bind(kanban)}); // 5 minutes
      }
      
      $('#auto_update').click(function() {
        autoUpdate();
        window.location.hash = kanban.el.attr('class');
      });
      
      $('#full_screen_link').click(function() {
        kanban.showFullScreen();
        window.location.hash = kanban.el.attr('class');
      });
      
      $(document).keydown(function(e) {
        if(e.keyCode == 27) {
          kanban.showNormal();
          window.location.hash = kanban.el.attr('class');
        }
      });
      
      var options = window.location.hash.substring(1).split(' ');
      if(_.include(options, 'full-screen')) kanban.showFullScreen();
      if(_.include(options, 'auto-update')) autoUpdate();
      
      
      
      $('.kanban-column')
        .addClass('clickable')
        .hover(function() {
            var queue = $(this).attr('data-queue');
            $('.kanban-column[data-queue="' + queue + '"]').addClass('hover');
          }, function() {
            var queue = $(this).attr('data-queue');
            $('.kanban-column[data-queue="' + queue + '"]').removeClass('hover');
          })
        .click(function(e) {
            var $target = $(e.target);
            if($target.is('a') || $target.parents('a').length > 0) {
              return true;
            } else {
              window.location = window.location.pathname + '/' + $(this).attr('data-queue');
              return false;
            }
          });
      
    });
  </script>
<% end %>

<h1 class="project-banner <%= @project.color %>">
  <small>Test Results for</small> <%= @project.name %>
</h1>

<h2 class="test-result-banner <%= @test_run.result %>">
  <%= link_to @test_run.result, @test_run.results_url, target: "_blank" %>
</h2>

<% if @test_run.failed? %>
  <% if (blamable_commits = @test_run.blamable_commits).any? %>
    <div class="test-result-credit">
      <p>
        <%= blamable_commits.uniq_by(&:author_email).map { |commit|
              "<span class=\"test-result-committer\">#{gravatar_image commit.author_email, size: 48} #{commit.author_name}</span>"
            }.to_sentence(two_words_connector: " or ", last_word_connector: ", or ").html_safe %>
        broke the build.
        <%= image_tag image_url("emoji/disappointed_relieved.png") %>
      </p>
      
      See commits <%= link_to_commit_range @test_run.project, blamable_commits.last.sha, blamable_commits.first.sha %>
    </div>
  <% end %>
<% elsif @test_run.fixed? %>
  <% praisable_commits = @test_run.commits_since_last_test_run %>
  <div class="test-result-credit">
    <p>
      <%= praisable_commits.uniq_by(&:author_email).map { |commit|
            "<span class=\"test-result-committer\">#{gravatar_image commit.author_email, size: 48} #{commit.author_name}</span>"
          }.to_sentence.html_safe %>
      fixed the build!
      <%= image_tag image_url("emoji/star.png") %><%= image_tag image_url("emoji/trophy.png") %><%= image_tag image_url("emoji/star.png") %>
    </p>
    
    See commits <%= link_to_commit_range @test_run.project, praisable_commits.last.sha, praisable_commits.first.sha %>
  </div>
<% end %>

<div class="tests-detail">
  <% if @test_run.tests.nil? %>
    <p>The build failed without running tests.</p>
  <% elsif @test_run.tests.none? %>
    <p>This project does not have any tests.</p>
  <% else %>
    <% @test_run.tests.group_by { |test| test[:suite] }.each do |suite, tests| %>
      <div class="test-suite">
        <h3 class="test-suite-name"><%= suite %></h3>
        <ul class="tests">
          <% tests.each do |test| %>
            <li class="test <%= test[:status] %>">
              <span class="test-status <%= test[:status] %>"><%= test[:status] %></span><span class="test-name"><%= test[:name] %></span>&nbsp;
              <span class="test-duration">( <%= test[:duration].round(1) %>ms )</span>
              <% if test.fetch(:error_backtrace, []).any? %>
                <ol class="test-backtrace">
                  <li class="test-backtrace-line error-message"><%= test[:error_message] %></li>
                  <% test[:error_backtrace].each do |line| %>
                    <li class="test-backtrace-line"><%= format_backtrace_line(line) %></li>
                  <% end %>
                </ol>
              <% end %>
            </li>
          <% end %>
        </ul>
      </div>
    <% end %>
  <% end %>
</div>

<p style="text-align: right;"><%= link_to @test_run.results_url, @test_run.results_url, target: "_blank" %></p>
